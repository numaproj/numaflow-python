name: release

on:
  push:
    tags:
      - 'v*'
    branches:
      - main
      - dev-release*

jobs:
  docker_publish:
    name: Build, Tag, and Push Image
    runs-on: ubuntu-latest

    strategy:
      matrix:
        dockerfile_paths: [
          "examples/map/even_odd", "examples/map/flatmap", "examples/map/forward_message",
          "examples/map/multiproc_map", "examples/mapstream/flatmap_stream", "examples/reduce/asyncio-reduce",
          "examples/reduce/counter", "examples/sideinput/simple-sideinput", "examples/sideinput/simple-sideinput/udf",
          "examples/sink/async_log", "examples/sink/log", "examples/source/async-source", "examples/source/simple-source",
          "examples/sourcetransform/event_time_filter"
        ]

    steps:
      - name: Check out repository
        uses: actions/checkout@v3
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to Quay.io registry
        uses: docker/login-action@v3
        with:
          registry: quay.io
          username: ${{ secrets.NUMAIO_USERNAME }}
          password: ${{ secrets.NUMAIO_PASSWORD }}
      - name: Build, tag, and push images
        run: |
          ./hack/update_examples.sh --update latest
          ./hack/update_examples.sh --build-push-example ${{ matrix.dockerfile_paths }}
